{% extends 'base.html' %}
{% load static %}

{% block title %}Créer un Projet - InvestAfrik{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Créer un Nouveau Projet</h1>
            <p class="text-gray-600 mt-2">Présentez votre idée et commencez à lever des fonds</p>
        </div>

        <!-- Messages -->
        {% if messages %}
        <div class="mb-6">
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} mb-3 p-4 rounded-lg {% if message.tags == 'error' %}bg-red-50 border border-red-200 text-red-700{% elif message.tags == 'success' %}bg-green-50 border border-green-200 text-green-700{% elif message.tags == 'warning' %}bg-yellow-50 border border-yellow-200 text-yellow-700{% else %}bg-blue-50 border border-blue-200 text-blue-700{% endif %}">
                <div class="flex items-center">
                    <i class="fas {% if message.tags == 'error' %}fa-exclamation-circle{% elif message.tags == 'success' %}fa-check-circle{% elif message.tags == 'warning' %}fa-exclamation-triangle{% else %}fa-info-circle{% endif %} mr-2"></i>
                    {{ message }}
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Progress Steps -->
        <div class="mb-8">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="flex items-center justify-center w-8 h-8 bg-primary-600 text-white rounded-full text-sm font-medium">1</div>
                    <span class="ml-2 text-sm font-medium text-primary-600">Informations de base</span>
                </div>
                <div class="flex-1 mx-4 h-1 bg-gray-200 rounded"></div>
                <div class="flex items-center">
                    <div class="flex items-center justify-center w-8 h-8 bg-gray-200 text-gray-600 rounded-full text-sm font-medium">2</div>
                    <span class="ml-2 text-sm font-medium text-gray-600">Détails financiers</span>
                </div>
                <div class="flex-1 mx-4 h-1 bg-gray-200 rounded"></div>
                <div class="flex items-center">
                    <div class="flex items-center justify-center w-8 h-8 bg-gray-200 text-gray-600 rounded-full text-sm font-medium">3</div>
                    <span class="ml-2 text-sm font-medium text-gray-600">Médias et publication</span>
                </div>
            </div>
        </div>

        <!-- Form -->
        <form id="projectForm" method="post" enctype="multipart/form-data" class="bg-white rounded-lg shadow p-6">
            {% csrf_token %}
            <!-- Step 1: Basic Information -->
            <div id="step1" class="step">
                <h2 class="text-xl font-semibold text-gray-900 mb-6">Informations de Base</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="md:col-span-2">
                        <label for="title" class="block text-sm font-medium text-gray-700 mb-2">Titre du projet *</label>
                        <input type="text" id="title" name="title" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500"
                               placeholder="Ex: Application mobile pour l'agriculture intelligente" value="{{ request.POST.title|default:'' }}">
                    </div>

                    <div>
                        <label for="category" class="block text-sm font-medium text-gray-700 mb-2">Catégorie *</label>
                        <select id="category" name="category" required 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                            <option value="">Sélectionnez une catégorie</option>
                            {% for category in categories %}
                            <option value="{{ category.id }}" {% if request.POST.category == category.id|stringformat:"s" %}selected{% endif %}>{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div>
                        <label for="country" class="block text-sm font-medium text-gray-700 mb-2">Pays *</label>
                        <select id="country" name="country" required 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                            <option value="">Sélectionnez un pays</option>
                            <option value="CM" {% if request.POST.country == "CM" %}selected{% endif %}>Cameroun</option>
                            <option value="SN" {% if request.POST.country == "SN" %}selected{% endif %}>Sénégal</option>
                            <option value="CI" {% if request.POST.country == "CI" %}selected{% endif %}>Côte d'Ivoire</option>
                            <option value="BJ" {% if request.POST.country == "BJ" %}selected{% endif %}>Bénin</option>
                            <option value="TG" {% if request.POST.country == "TG" %}selected{% endif %}>Togo</option>
                            <option value="BF" {% if request.POST.country == "BF" %}selected{% endif %}>Burkina Faso</option>
                            <option value="ML" {% if request.POST.country == "ML" %}selected{% endif %}>Mali</option>
                            <option value="NE" {% if request.POST.country == "NE" %}selected{% endif %}>Niger</option>
                            <option value="GN" {% if request.POST.country == "GN" %}selected{% endif %}>Guinée</option>
                            <option value="GH" {% if request.POST.country == "GH" %}selected{% endif %}>Ghana</option>
                            <option value="NG" {% if request.POST.country == "NG" %}selected{% endif %}>Nigeria</option>
                            <option value="KE" {% if request.POST.country == "KE" %}selected{% endif %}>Kenya</option>
                        </select>
                    </div>

                    <div class="md:col-span-2">
                        <label for="short_description" class="block text-sm font-medium text-gray-700 mb-2">Description courte *</label>
                        <textarea id="short_description" name="short_description" required rows="3" maxlength="200"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500"
                                  placeholder="Résumez votre projet en quelques phrases (max 200 caractères)">{{ request.POST.short_description|default:'' }}</textarea>
                        <p class="text-sm text-gray-500 mt-1">0/200 caractères</p>
                    </div>

                    <div class="md:col-span-2">
                        <label for="full_description" class="block text-sm font-medium text-gray-700 mb-2">Description complète *</label>
                        <textarea id="full_description" name="full_description" required rows="8"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500"
                                  placeholder="Décrivez votre projet en détail (minimum 50 caractères)...">{{ request.POST.full_description|default:'' }}</textarea>
                        <p class="text-sm text-gray-500 mt-1">Minimum 50 caractères</p>
                    </div>
                </div>

                <div class="flex justify-end mt-6">
                    <button type="button" onclick="nextStep()" class="btn-primary">
                        Suivant <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>

            <!-- Step 2: Financial Details -->
            <div id="step2" class="step hidden">
                <h2 class="text-xl font-semibold text-gray-900 mb-6">Détails Financiers</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="goal_amount" class="block text-sm font-medium text-gray-700 mb-2">Objectif de financement (FCFA) *</label>
                        <input type="number" id="goal_amount" name="goal_amount" required min="100000" step="1000"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500"
                               placeholder="Ex: 5000000" value="{{ request.POST.goal_amount|default:'' }}">
                        <p class="text-sm text-gray-500 mt-1">Minimum: 100,000 FCFA</p>
                    </div>

                    <div>
                        <label for="duration" class="block text-sm font-medium text-gray-700 mb-2">Durée de la campagne (jours) *</label>
                        <select id="duration" name="duration" required 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                            <option value="">Sélectionnez la durée</option>
                            <option value="30" {% if request.POST.duration == "30" %}selected{% endif %}>30 jours</option>
                            <option value="45" {% if request.POST.duration == "45" %}selected{% endif %}>45 jours</option>
                            <option value="60" {% if request.POST.duration == "60" %}selected{% endif %}>60 jours</option>
                            <option value="90" {% if request.POST.duration == "90" %}selected{% endif %}>90 jours</option>
                        </select>
                    </div>

                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-4">Répartition du budget (optionnel)</label>
                        <div id="budget-breakdown" class="space-y-3">
                            <div class="flex items-center space-x-3">
                                <input type="text" name="budget_item[]" placeholder="Poste de dépense" 
                                       class="flex-1 px-3 py-2 border border-gray-300 rounded-md">
                                <input type="number" name="budget_amount[]" placeholder="Montant (FCFA)" 
                                       class="w-32 px-3 py-2 border border-gray-300 rounded-md">
                                <button type="button" onclick="removeBudgetItem(this)" class="text-red-600 hover:text-red-700">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <button type="button" onclick="addBudgetItem()" class="mt-3 text-orange-600 hover:text-orange-700 text-sm">
                            <i class="fas fa-plus mr-1"></i>Ajouter un poste
                        </button>
                    </div>
                </div>

                <div class="flex justify-between mt-6">
                    <button type="button" onclick="prevStep()" class="btn-secondary">
                        <i class="fas fa-arrow-left mr-2"></i>Précédent
                    </button>
                    <button type="button" onclick="nextStep()" class="btn-primary">
                        Suivant <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>

            <!-- Step 3: Media and Publication -->
            <div id="step3" class="step hidden">
                <h2 class="text-xl font-semibold text-gray-900 mb-6">Médias et Publication</h2>
                
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Image principale *</label>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                            <input type="file" id="featured_image" name="featured_image" accept="image/*" class="hidden">
                            <div id="image-preview" class="hidden">
                                <img id="preview-img" class="max-w-full h-48 mx-auto rounded-lg">
                                <button type="button" onclick="removeImage()" class="mt-2 text-red-600 hover:text-red-700 text-sm">
                                    Supprimer l'image
                                </button>
                            </div>
                            <div id="image-upload" class="cursor-pointer" onclick="document.getElementById('featured_image').click()">
                                <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                                <p class="text-gray-600">Cliquez pour télécharger une image</p>
                                <p class="text-sm text-gray-500">PNG, JPG jusqu'à 5MB</p>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label for="video_url" class="block text-sm font-medium text-gray-700 mb-2">Vidéo de présentation (optionnel)</label>
                        <input type="url" id="video_url" name="video_url"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500"
                               placeholder="https://youtube.com/watch?v=..." value="{{ request.POST.video_url|default:'' }}">
                        <p class="text-sm text-gray-500 mt-1">URL YouTube ou Vimeo</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Statut de publication</label>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="radio" name="status" value="draft" {% if request.POST.status == "draft" or not request.POST.status %}checked{% endif %} class="mr-2">
                                <span>Brouillon - Sauvegarder sans publier</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="status" value="pending" {% if request.POST.status == "pending" %}checked{% endif %} class="mr-2">
                                <span>Soumettre pour validation - Publier après approbation</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="flex justify-between mt-6">
                    <button type="button" onclick="prevStep()" class="btn-secondary">
                        <i class="fas fa-arrow-left mr-2"></i>Précédent
                    </button>
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-save mr-2"></i>Créer le Projet
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
let currentStep = 1;

document.addEventListener('DOMContentLoaded', function() {
    setupFormHandlers();
    updateProgressBar();
});

function setupFormHandlers() {
    // Character counter for short description
    const shortDesc = document.getElementById('short_description');
    const counter = shortDesc.nextElementSibling;
    
    shortDesc.addEventListener('input', function() {
        const count = this.value.length;
        counter.textContent = `${count}/200 caractères`;
        if (count > 200) {
            counter.classList.add('text-red-500');
            counter.classList.remove('text-gray-500');
        } else {
            counter.classList.remove('text-red-500');
            counter.classList.add('text-gray-500');
        }
    });
    
    // Trigger initial count
    shortDesc.dispatchEvent(new Event('input'));

    // Image upload handler
    const imageInput = document.getElementById('featured_image');
    if (imageInput) {
        imageInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('preview-img').src = e.target.result;
                    document.getElementById('image-preview').classList.remove('hidden');
                    document.getElementById('image-upload').classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
        });
    }
}

function nextStep() {
    if (validateStep(currentStep)) {
        document.getElementById(`step${currentStep}`).classList.add('hidden');
        currentStep++;
        document.getElementById(`step${currentStep}`).classList.remove('hidden');
        updateProgressBar();
    }
}

function prevStep() {
    document.getElementById(`step${currentStep}`).classList.add('hidden');
    currentStep--;
    document.getElementById(`step${currentStep}`).classList.remove('hidden');
    updateProgressBar();
}

function updateProgressBar() {
    // Update progress indicators
    const steps = document.querySelectorAll('.flex.items-center');
    
    steps.forEach((stepElement, index) => {
        const stepNumber = index + 1;
        const circle = stepElement.querySelector('.w-8');
        const text = stepElement.querySelector('span');
        
        if (stepNumber <= currentStep) {
            circle.classList.remove('bg-gray-200', 'text-gray-600');
            circle.classList.add('bg-orange-600', 'text-white');
            text.classList.remove('text-gray-600');
            text.classList.add('text-orange-600');
        } else {
            circle.classList.remove('bg-orange-600', 'text-white');
            circle.classList.add('bg-gray-200', 'text-gray-600');
            text.classList.remove('text-orange-600');
            text.classList.add('text-gray-600');
        }
    });
}

function validateStep(step) {
    const stepDiv = document.getElementById(`step${step}`);
    const requiredFields = stepDiv.querySelectorAll('[required]');
    
    let isValid = true;
    requiredFields.forEach(field => {
        if (!field.value.trim()) {
            field.classList.add('border-red-500');
            isValid = false;
        } else {
            field.classList.remove('border-red-500');
        }
    });

    // Validation spéciale pour l'étape 1
    if (step === 1) {
        const fullDesc = document.getElementById('full_description');
        if (fullDesc.value.trim().length < 50) {
            fullDesc.classList.add('border-red-500');
            alert('La description complète doit contenir au moins 50 caractères');
            isValid = false;
        } else {
            fullDesc.classList.remove('border-red-500');
        }
    }

    return isValid;
}

function addBudgetItem() {
    const container = document.getElementById('budget-breakdown');
    const div = document.createElement('div');
    div.className = 'flex items-center space-x-3';
    div.innerHTML = `
        <input type="text" name="budget_item[]" placeholder="Poste de dépense" 
               class="flex-1 px-3 py-2 border border-gray-300 rounded-md">
        <input type="number" name="budget_amount[]" placeholder="Montant (FCFA)" 
               class="w-32 px-3 py-2 border border-gray-300 rounded-md">
        <button type="button" onclick="removeBudgetItem(this)" class="text-red-600 hover:text-red-700">
            <i class="fas fa-trash"></i>
        </button>
    `;
    container.appendChild(div);
}

function removeBudgetItem(button) {
    button.parentElement.remove();
}

function removeImage() {
    document.getElementById('featured_image').value = '';
    document.getElementById('image-preview').classList.add('hidden');
    document.getElementById('image-upload').classList.remove('hidden');
}
</script>
{% endblock %}